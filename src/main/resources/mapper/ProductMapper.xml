<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    상품 Mapper XML
    MyBatis 동적 SQL 고급 기능:
    - <where>: WHERE 절 자동 생성
    - <if>: 조건부 SQL
    - <foreach>: 컬렉션 반복 (IN 절 등)
    - <choose>, <when>, <otherwise>: switch-case 같은 조건문
-->
<mapper namespace="example.mapper.ProductMapper">

    <select id="findAll" resultType="Product">
        SELECT id, name, description, price, stock_quantity, category, status,
               created_at, updated_at
        FROM products
        ORDER BY created_at DESC
    </select>

    <select id="findById" resultType="Product">
        SELECT id, name, description, price, stock_quantity, category, status,
               created_at, updated_at
        FROM products
        WHERE id = #{id}
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO products (name, description, price, stock_quantity, category, status,
                            created_at, updated_at)
        VALUES (#{name}, #{description}, #{price}, #{stockQuantity}, #{category}, #{status},
                CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    </insert>

    <!--
        동적 SQL을 사용한 상품 정보 수정
    -->
    <update id="update">
        UPDATE products
        <set>
            <if test="name != null and name != ''">
                name = #{name},
            </if>
            <if test="description != null">
                description = #{description},
            </if>
            <if test="price != null">
                price = #{price},
            </if>
            <if test="stockQuantity != null">
                stock_quantity = #{stockQuantity},
            </if>
            <if test="category != null and category != ''">
                category = #{category},
            </if>
            <if test="status != null and status != ''">
                status = #{status},
            </if>
            updated_at = CURRENT_TIMESTAMP
        </set>
        WHERE id = #{id}
    </update>

    <!--
        복잡한 검색 조건을 사용한 상품 조회
        <where>: WHERE 절 자동 생성, 첫 번째 AND/OR 자동 제거
        <foreach>: 컬렉션을 반복하여 IN 절 생성
            collection: 반복할 컬렉션 이름
            item: 반복 시 현재 항목을 참조할 변수명
            open: 시작 문자
            close: 종료 문자
            separator: 구분자
    -->
    <select id="search" resultType="Product">
        SELECT id, name, description, price, stock_quantity, category, status,
               created_at, updated_at
        FROM products
        <where>
            <!-- 상품명 부분 검색 (LIKE) -->
            <if test="name != null and name != ''">
                AND name LIKE CONCAT('%', #{name}, '%')
            </if>

            <!-- 카테고리 리스트로 검색 (IN 절) -->
            <if test="categories != null and categories.size() > 0">
                AND category IN
                <foreach collection="categories" item="category" open="(" close=")" separator=",">
                    #{category}
                </foreach>
            </if>

            <!-- 가격 범위 검색 -->
            <if test="minPrice != null">
                AND price &gt;= #{minPrice}
            </if>
            <if test="maxPrice != null">
                AND price &lt;= #{maxPrice}
            </if>

            <!-- 재고 있는 상품만 조회 -->
            <if test="inStockOnly != null and inStockOnly == true">
                AND stock_quantity &gt; 0
            </if>

            <!-- 상태 리스트로 검색 -->
            <if test="statuses != null and statuses.size() > 0">
                AND status IN
                <foreach collection="statuses" item="status" open="(" close=")" separator=",">
                    #{status}
                </foreach>
            </if>
        </where>
        ORDER BY created_at DESC
    </select>

    <!--
        카테고리별 상품 가격 일괄 업데이트
        SQL에서 직접 계산 수행
    -->
    <update id="updatePricesByCategory">
        UPDATE products
        SET price = price * #{priceMultiplier},
            updated_at = CURRENT_TIMESTAMP
        WHERE category = #{category}
    </update>

</mapper>
